@{
    ViewData["Title"] = "Tasks";
    Layout = "~/Views/Shared/_LayoutApp.cshtml";
    var moduleId = ViewBag.ModuleId as Guid?;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title">Tasks</h3>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal" id="createTaskBtn">
                            <i class="fas fa-plus"></i> Create Task
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="tasksList">
                        <!-- Tasks will be loaded here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTaskModalLabel">Create Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Create form will be loaded here by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Edit form will be loaded here by JavaScript -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load tasks when page loads
            loadTasks();
            
            // Load create modal content when create button is clicked
            document.getElementById('createTaskBtn').addEventListener('click', function() {
                loadCreateModal();
            });
        });
        
        function loadTasks() {
            fetch(`/api/modules/${'@moduleId'}/tasks`)
                .then(response => response.json())
                .then(data => {
                    let tasksHtml = '';
                    if (data.length > 0) {
                        tasksHtml = '<div class="row">';
                        data.forEach(function(task) {
                            tasksHtml += `
                                <div class="col-md-4 mb-3">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title">${task.name}</h5>
                                            <p class="card-text">${task.description}</p>
                                            <p class="card-text"><small class="text-muted">Sort Order: ${task.sortOrder}</small></p>
                                            <p class="card-text"><small class="text-muted">Is ERD: ${task.isErd ? 'Yes' : 'No'}</small></p>
                                            <button class="btn btn-sm btn-outline-primary edit-task-btn" data-task-id="${task.id}">Edit</button>
                                            <button class="btn btn-sm btn-outline-danger delete-task-btn" data-task-id="${task.id}">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        tasksHtml += '</div>';
                    } else {
                        tasksHtml = '<p>No tasks found.</p>';
                    }
                    
                    document.getElementById('tasksList').innerHTML = tasksHtml;
                    
                    // Attach event handlers for edit buttons
                    document.querySelectorAll('.edit-task-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const taskId = this.getAttribute('data-task-id');
                            loadEditModal(taskId);
                        });
                    });
                    
                    // Attach event handlers for delete buttons
                    document.querySelectorAll('.delete-task-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const taskId = this.getAttribute('data-task-id');
                            deleteTask(taskId);
                        });
                    });
                })
                .catch(error => console.error('Error loading tasks:', error));
        }
        
        function loadCreateModal() {
            fetch(`/TaskView/CreateModal?moduleId=${'@moduleId'}`)
                .then(response => response.text())
                .then(data => {
                    document.querySelector('#createTaskModal .modal-body').innerHTML = data;
                    var createModal = new bootstrap.Modal(document.getElementById('createTaskModal'));
                    createModal.show();
                })
                .catch(error => console.error('Error loading create modal:', error));
        }
        
        function loadEditModal(taskId) {
            fetch(`/TaskView/EditModal?moduleId=${'@moduleId'}&taskId=${taskId}`)
                .then(response => response.text())
                .then(data => {
                    document.querySelector('#editTaskModal .modal-body').innerHTML = data;
                    var editModal = new bootstrap.Modal(document.getElementById('editTaskModal'));
                    editModal.show();
                })
                .catch(error => console.error('Error loading edit modal:', error));
        }
        
        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                fetch(`/api/modules/${'@moduleId'}/tasks/${taskId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        loadTasks(); // Reload tasks list
                        alert('Task deleted successfully');
                    } else {
                        throw new Error('Failed to delete task');
                    }
                })
                .catch(error => {
                    console.error('Error deleting task:', error);
                    alert('Error deleting task: ' + error.message);
                });
            }
        }
    </script>
}